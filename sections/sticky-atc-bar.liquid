{%- comment -%}
  Sticky Add to Cart Bar
  Funcionalidade: Barra fixa inferior com informações do produto e botão de compra.
  Layout: Flexbox em Desktop, Grid Customizado em Mobile.
  Integração: AJAX Cart API + Section Rendering API para atualização dinâmica do Drawer.
{%- endcomment -%}

<style>
  /* * CONFIGURAÇÕES DE LAYOUT (DESKTOP)
   * Utiliza Flexbox para distribuir elementos horizontalmente.
   */
  .sticky-atc-wrapper {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #ffffff;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
    z-index: 9999;
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
    border-top: 1px solid #e5e5e5;
  }

  .sticky-atc-wrapper.is-visible {
    transform: translateY(0);
  }

  .sticky-atc-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    padding: 15px 20px;
    margin: 0 auto;
    width: 100%;
    max-width: var(--page-width, 1200px); 
  }

  /* Bloco de Informações (Imagem e Texto) */
  .sticky-atc-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
    overflow: hidden;
  }

  .sticky-atc-img {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #f0f0f0;
  }

  .sticky-atc-text {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
  }

  .sticky-atc-title {
    font-size: 16px;
    font-weight: 700;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
    max-width: 350px;
  }

  .sticky-atc-price {
    font-size: 15px;
    color: #555;
    font-weight: 500;
  }

  /* Bloco de Ações (Botões) */
  .sticky-atc-actions {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .sticky-atc-btn {
    background-color: {{ section.settings.btn_color }};
    color: {{ section.settings.btn_text_color }};
    border: none;
    padding: 14px 30px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    border-radius: 8px;
    white-space: nowrap;
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .sticky-atc-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .sticky-atc-btn.loading {
    opacity: 0.7;
    cursor: wait;
  }

  .sticky-atc-close {
    background: transparent;
    border: none;
    font-size: 28px;
    color: #999;
    cursor: pointer;
    line-height: 1;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* * CONFIGURAÇÕES DE LAYOUT (MOBILE)
   * Utiliza CSS Grid para reorganizar a ordem visual dos elementos.
   * Breakpoint: 768px
   */
  @media (max-width: 768px) {
    .sticky-atc-container {
      display: grid;
      grid-template-columns: 75px 1fr auto; 
      grid-template-rows: auto auto; 
      column-gap: 12px;
      row-gap: 8px;
      padding: 12px 15px;
      align-items: center; 
    }

    /* Remove display flex dos containers filhos para permitir controle via Grid */
    .sticky-atc-info { display: contents; } 
    
    /* Posicionamento Imagem: Coluna 1, Ocupa 2 linhas */
    .sticky-atc-img {
      grid-column: 1;
      grid-row: 1 / span 2; 
      width: 75px; 
      height: 75px;
      margin: 0;
    }

    /* Posicionamento Texto: Coluna 2, Linha 1 */
    .sticky-atc-text {
      grid-column: 2;
      grid-row: 1;
      align-self: end; 
      gap: 0px; 
    }
    
    .sticky-atc-title {
      font-size: 14px;
      max-width: 100%;
      white-space: nowrap;
    }
    
    .sticky-atc-price {
      font-size: 13px;
      color: #666;
    }

    .sticky-atc-actions { display: contents; }

    /* Botão Fechar: Coluna 3, Linha 1 */
    .sticky-atc-close {
      grid-column: 3;
      grid-row: 1;
      font-size: 24px;
      align-self: start;
      padding: 0;
    }

    /* Botão Adicionar: Coluna 2 a 3, Linha 2 */
    .sticky-atc-btn {
      grid-column: 2 / span 2; 
      grid-row: 2;
      width: 100%;
      padding: 0;
      height: 38px; 
      font-size: 14px;
      align-self: start; 
    }
  }
</style>

<div id="sticky-atc-bar" class="sticky-atc-wrapper" aria-hidden="true">
  <div class="sticky-atc-container page-width">
    
    <div class="sticky-atc-info">
      {% if product.featured_image %}
        <img src="{{ product.featured_image | img_url: '150x' }}" alt="{{ product.title }}" class="sticky-atc-img" loading="lazy">
      {% endif %}
      <div class="sticky-atc-text">
        <p class="sticky-atc-title">{{ product.title }}</p>
        <span class="sticky-atc-price">{{ product.price | money }}</span>
      </div>
    </div>

    <div class="sticky-atc-actions">
      <button type="button" class="sticky-atc-btn" id="sticky-atc-trigger">
        {{ section.settings.btn_text | default: 'Adicionar' }}
      </button>
      
      <button type="button" class="sticky-atc-close" id="sticky-atc-close-btn" aria-label="Fechar barra">
        &times;
      </button>
    </div>
    
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Inicialização de seletores DOM
    const stickyBar = document.getElementById('sticky-atc-bar');
    const stickyBtn = document.getElementById('sticky-atc-trigger');
    const closeBtn = document.getElementById('sticky-atc-close-btn');
    
    let userClosed = false;

    // Identifica o formulário principal do produto para capturar dados (ID da variante)
    const mainForm = document.querySelector('form[action*="/cart/add"]');
    
    // Identifica o botão original de compra para monitoramento de scroll (IntersectionObserver)
    let originalBtn = mainForm ? mainForm.querySelector('[type="submit"]') : null;
    
    // Fallback para seletores comuns caso o botão não esteja dentro do form padrão
    if (!originalBtn) {
      originalBtn = document.querySelector('.product-form__submit, .add-to-cart, button[name="add"]');
    }

    if (!stickyBar || !originalBtn) return;

    // ---------------------------------------------------------
    // EVENT LISTENER: ADICIONAR AO CARRINHO
    // ---------------------------------------------------------
    stickyBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if(!mainForm) return;

      // Feedback visual de carregamento
      const originalText = stickyBtn.innerText;
      stickyBtn.innerText = '...';
      stickyBtn.classList.add('loading');

      // Prepara os dados do formulário para submissão via AJAX
      const formData = new FormData(mainForm);

      // 1. Envio dos dados para a API do Carrinho Shopify
      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // Sucesso na adição ao carrinho. Inicia atualização dos componentes da interface.
        
        // Recupera dinamicamente o ID da seção do carrinho para uso na Section Rendering API.
        // O seletor baseia-se na estrutura do tema (cart-items-component).
        const drawerComponent = document.querySelector('cart-items-component');
        const sectionId = drawerComponent ? drawerComponent.dataset.sectionId : null;

        if (sectionId) {
            // 2. Requisição assíncrona para obter o HTML atualizado da seção do carrinho
            fetch(`${window.location.pathname}?section_id=${sectionId}`)
                .then(res => res.text())
                .then(text => {
                    // Parser do texto recebido para HTML Document
                    const html = new DOMParser().parseFromString(text, 'text/html');
                    
                    // Seleciona o novo conteúdo e o elemento alvo no DOM atual
                    const newDrawerContent = html.querySelector('cart-items-component');
                    const oldDrawerContent = document.querySelector('cart-items-component');

                    // 3. Substituição do HTML do drawer para refletir o novo item adicionado
                    if (newDrawerContent && oldDrawerContent) {
                        oldDrawerContent.innerHTML = newDrawerContent.innerHTML;
                    }

                    // Atualização do contador do ícone do carrinho (Bubble Count), se existir
                    const cartIconBubble = document.querySelector('#cart-icon-bubble');
                    const newCartIconBubble = html.querySelector('#cart-icon-bubble');
                    if(cartIconBubble && newCartIconBubble) {
                        cartIconBubble.innerHTML = newCartIconBubble.innerHTML;
                    }

                    // 4. Acionamento do Drawer
                    // Simula clique no botão interno do componente para abrir o menu lateral
                    const cartIcon = document.querySelector('cart-drawer-component button') || document.querySelector('[data-testid="cart-icon"]');
                    if (cartIcon) cartIcon.click();

                    // Restaura estado inicial do botão e oculta a barra sticky
                    stickyBtn.innerText = originalText;
                    stickyBtn.classList.remove('loading');
                    stickyBar.classList.remove('is-visible');
                })
                .catch(err => {
                   console.error('Falha ao atualizar a seção do carrinho:', err);
                   // Redirecionamento de fallback em caso de erro na renderização da seção
                   window.location.href = '/cart';
                });
        } else {
            // Se o ID da seção não for encontrado, redireciona para a página do carrinho
            window.location.href = '/cart';
        }
      })
      .catch((error) => {
        console.error('Erro na requisição AJAX (/cart/add.js):', error);
        // Fallback: Aciona o botão original do tema caso o AJAX falhe
        originalBtn.click();
        stickyBtn.innerText = originalText;
        stickyBtn.classList.remove('loading');
      });
    });

    // ---------------------------------------------------------
    // CONTROLE DE EXIBIÇÃO E FECHAMENTO
    // ---------------------------------------------------------
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      stickyBar.classList.remove('is-visible');
      userClosed = true; // Define flag para impedir reabertura automática na mesma sessão
    });

    // IntersectionObserver: Monitora a visibilidade do botão de compra principal
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        // Exibe a barra apenas se o botão principal não estiver visível E o usuário não tiver fechado manualmente
        if (!entry.isIntersecting && !userClosed) {
          stickyBar.classList.add('is-visible');
        } else {
          stickyBar.classList.remove('is-visible');
        }
      });
    }, {
      root: null,
      threshold: 0, 
      rootMargin: "0px"
    });

    observer.observe(originalBtn);
  });
</script>

{% schema %}
{
  "name": "Sticky Add to Cart",
  "settings": [
    {
      "type": "text",
      "id": "btn_text",
      "label": "Texto do Botão",
      "default": "Adicionar ao carrinho"
    },
    {
      "type": "color",
      "id": "btn_color",
      "label": "Cor do Botão",
      "default": "#FCD700"
    },
    {
      "type": "color",
      "id": "btn_text_color",
      "label": "Cor do Texto do Botão",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "Sticky Add to Cart"
    }
  ],
  "templates": ["product"]
}
{% endschema %}